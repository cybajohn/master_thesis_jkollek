%csky stuff
\chapter{Time-Integrated Search}

This chapter describes the time-integrated stacking search, starting with the properties of the analysis, followed by a description of the background trials and finally the signal trials with the result of the sensitivity and the discovery potential.
The search covers different spectral indices for the signal event emission.

\section{Analysis properties}

This section shows some of the underlying PDFs csky uses to calculate the test statistic values.
Since csky is based on PDF ratios for practical reasons, not all individual PDFs can be shown clearly.
Consequently, here are a few basic PDFs and ratios whose form is apriori important for the quality of the analysis.

\subsection{Background space PDF}

The background space PDF is generated with data and only depends on the declination $\delta$ of the events, given by the almost right ascension symmetry of the IceCube detector due to its position.
It is normalized over the whole sky, hence satisfying the condition
\begin{align}
  \int d\Omega f = \int d\alpha \int d(\sin(\delta)) f = 1
\end{align}
and is shown in figure \ref{fig:bg_param_time_int}.
Lastly a spline, interpolating between the bin centers, is used to evaluate the events.
\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{Plots/05_csky/bg_space_pdf.pdf}
    \caption{Background space PDF used in this analysis in $\sin{(\delta)}$ for all $\num{9}$ years, 2011-2019.}
    \label{fig:bg_param_time_int}
\end{figure}
The background space parametrization results in one plot only because all datasets underwent the same data processing pipeline.
The PDF shows a lower contribution for downgoing events and a higher one for upgoing events coming from the sides.
This result is compatible with other analyses, for example ...

\subsection{Energy ratio PDF}

The energy PDF ratios for different spectral indices $\gamma$ can be seen in figure \ref{fig:energy_ratio_time_int}.

\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{Plots/05_csky/energy_pdf_ratio.pdf}
    \caption{Energy PDF ratios used in this analysis in $\sin{(\delta)}$ and $\sin{\log{(E)}}$ for all $\num{9}$ years, 2011-2019, for different spectral indices $\gamma$.}
    \label{fig:energy_ratio_time_int}
\end{figure}

Mention high values in upper right (okay since they bias towards lower sens values (weaken)) and lower left (bad, bias towards higher sens values)

\section{Background Trials}

The histogram of the background test statistic values can be seen in figure \ref{fig:bg_ts_time_int}.
The number of trials processed is $\num{974000}$\footnote{Originally $\num{e6}$, but some jobs fail due to various technical reasons.}.
Important features of the plot are that the $\chi^2$ distribution has as straight a tail as possible.
This is reflected in the number of degrees of freedom $dof$ in the $\chi^2$ distribution.
This should be as close to 1 as possible, which corresponds to a pure background statistic without signal.
The test statistic should also be symmetrical around the zero point.
A shift around the zero point is an indication of an undesired bias of the statistic.
Therefore, the value of the quotient of the number of positive and negative events should ideally be $\eta = \num{0.5}$.
Apart from the fit parameters, the median and $5\sigma$ deviation value of the test statistic are necessary for the subsequent calculation of the sensitivity and the discovery potential.

The fit parameters of the background test statistic are
\begin{align}
  dof &= \num{1.115},\\
  \eta &= \num{0.656}
\end{align}
and the key values later to be processed are as follows\footnote{Some analyses use the $3\sigma$ value for the discovery potential}
\begin{align}
  median &= \num{0.140},\\
  3\sigma &= \num{10.651},\\
  5\sigma &= \num{28.060}.
\end{align}

\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{Plots/05_csky/9_years_gfu_gold_bg_new.pdf}
    \caption{Histogram of the background test statistic for the time integrated analysis. Shown are also the number of degrees of freedom $dof$ and the ratio of positive and negative values $\eta$.}
    \label{fig:bg_ts_time_int}
\end{figure}

\section{Signal Trials}

Before calculating the sensitivities and discovery potentials, certain properties of the likelihood or its behaviour should be investigated.
Since the spectral index $\gamma$ and the signal parameter $n_\text{S}$ are fitted, it is advisable to look at the likelihood environment to check for a smooth landscape to ensure a fit is possible and to exclude any other unwanted local maxima.
A scan of the parameter space for one likelihood can be seen in figure \ref{fig:llh_scan_time_int}.
Although there is a relatively flat maximum, the likelihood environment does not show any strange behaviour.
\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{Plots/05_csky/llh_scan_time_int.pdf}
    \caption{Scan of the likelihoodspace for the time integrated analysis. The number of induced signal events is $n_S = \num{100}$ with a spectral index of $\gamma = 2$. The maximum test statistic value is marked in the plot.}
    \label{fig:llh_scan_time_int}
\end{figure}
The method of the calculation of the contours comes from \cite{Blobel} and corresponds to the maximum of the negative log-likelihood after subtracting $\num{0.5}$ and $\num{2}$ accordingly to get the $1\sigma$ and $2\sigma$ range, respectively.

After the fit behaviour has been checked, the signal can be injected.
With a higher number of signal events, the test statistic shifts to higher values, eventually reaching the thresholds set for the sensitivity and discovery potential.
Practically csky provides methods to apriori get an estimation of the number of signal events that have to be injected to satisfy certain thresholds without having to run a lot of trials on a cluster first.
The determined list of the number of signal events injected for the trials can be seen in table \ref{tab:signal_injected}.
The resulting CDFs for the time integrated sensitivities and discovery potentials can be seen in figure \ref{fig:cdf_sens} and \ref{fig:cdf_disc}.
Each point corresponds to the percentage of the test statistic being passed the thresholds mentioned in chapter \ref{sec:theory}.
\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{Plots/05_csky/9_years_gfu_gold_cdf_sens.pdf}
    \caption{Quantiles of the signal trials for the calculation of the sensitivity for different spectral indices $\gamma$. A $\chi^2$ CDF fit provides a more accurate estimate of the sought signal parameter $n_\text{S}$ which satisfies the sensitivity condition at $\SI{90}{\percent}$.}
    \label{fig:cdf_sens}
\end{figure}
Note that all plots in figure \ref{fig:cdf_sens} start at about $\SI{50}{\percent}$ with a signal parameter of $n_\text{S} = 0$.
Since the absence of a signal parameter produces the background test statistic, the statistics share the same median, hence there will always be $\SI{50}{\percent}$ of the signal test statistic above the median of the background test statistic.
\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{Plots/05_csky/9_years_gfu_gold_cdf_disc.pdf}
    \caption{Quantiles of the signal trials for the calculation of the discovery potential for different spectral indices $\gamma$. A $\chi^2$ CDF fit provides a more accurate estimate of the sought signal parameter $n_\text{S}$ which satisfies the condition of the discovery potential at $\SI{50}{\percent}$.}
    \label{fig:cdf_disc}
\end{figure}
The sensitivities and discovery potentials from the CDFs can be seen in figure \ref{fig:sens_disc_time_int} and additionally in table \ref{tab:sens_disc_time_int}.
The values rise for higher spectral indices since the signal looks more background like the closer the spectral index is to $\gamma = 3$.
\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{Plots/05_csky/time_int_sens_gfu_gold_9_years_new.pdf}
    \caption{Sensitivities and discovery potentials for different spectral indices $\gamma$. The reference energy is $E_0 = \SI{1}{\tera\electronvolt}$.}
    \label{fig:sens_disc_time_int}
\end{figure}

\begin{table}
  \centering
  \caption{Sensitivities and discovery potentials for different spectral indices $\gamma$ at a reference energy of $E_0 = \SI{1}{\tera\electronvolt}$. Additionally the fitted number of signal events $N_\text{sig}$ satisfying the thresholds is shown.}
  \begin{tabular}{crcrc}
    \toprule
    $\gamma$ & $N_\text{sig,sens}$ &  sens in $\si{\tera\electronvolt\tothe{-1}\centi\meter\tothe{-2}\second\tothe{-1}}$ & $N_\text{sig,disc}$ & disc in $\si{\tera\electronvolt\tothe{-1}\centi\meter\tothe{-2}\second\tothe{-1}}$ \\
    \toprule
      \input{../tables/res_time_int_table.tex}
    \toprule
    \label{tab:sens_disc_time_int}
  \end{tabular}
\end{table}

\section{Examination of Fit Bias}

Several crosschecks can be made to examine the quality of the analysis results.
One of them is to check the fit of the parameters $\gamma$ and $n_\text{S}$ for bias.
The fit behaviour of the analysis can be seen in figure \ref{fig:fit_bias_gamma} for $\gamma$ and in figure \ref{fig:fit_bias_ns} for $n_\text{S}$.
The fitted spectral index is generally larger than the injected one and starts of at a spectral index of around $\hat\gamma = \num{3}$ with no injected signal events, because no signal events are equivalent to the statement that only background exists which has a spectral index of $\gamma = \num{3}$.
The larger fitted spectral index makes the analysis more conservative and therefore is not harmful for the overall results at spectral indices up to $\gamma = \num{2.5}$.
For higher spectral indices the fitted $\hat\gamma$ starts to sink below the set spectral index, since it is hard to fit for signal events that look like background. On the contrary this is harmful to the analysis results.
Equivalent behaviour can be seen for the fitted signal parameter $\hat{n}_\text{S}$.
\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{Plots/05_csky/gamma_fit_auto_3.pdf}
    \caption{Fitted spectral index $\hat\gamma$ in dependence of the injected number of signal events $n_\text{inj}$ with spectral index $\gamma$, shown with a horizontal black dashed line, for the trials used in the time integrated analysis.}
    \label{fig:fit_bias_gamma}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{Plots/05_csky/ns_fit_auto_4.pdf}
    \caption{Fitted number of signal events $\hat{n}_{\text{S}}$ in dependence of the injected number of signal events $n_\text{inj}$ with spectral index $\gamma$. The black dashed line shows the equality of fitted and injected number of signal events.}
    \label{fig:fit_bias_ns}
\end{figure}

\chapter{Time-Dependent Search}

\section{Background Trials}

\begin{figure}
    \centering
    \includegraphics[width=5cm]{Plots/05_csky/9_years_gfu_gold_time_dep_bg_t0.pdf}
    \caption{.}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=5cm]{Plots/05_csky/9_years_gfu_gold_time_dep_bg_timewindows_fixed_t0.pdf}
    \caption{.}
\end{figure}

ns = 2 because the time box is set between 2 events, thus ns = 2 and maybe lower because of weighting (events may not look as signal like)
\section{Signal Trials}

\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{Plots/05_csky/llh_scan.pdf}
    \caption{Scan of the likelihoodspace for every source with a timewindow of $\SI{200}{\day}$. The scan is in the spectral index $\gamma$ and the signal parameter $n_S$. The source number corresponds to table \ref{tab:sources}.}
    \label{fig:llh_scan_time_dep}
\end{figure}
