%appendix
\chapter{Supplementary Material} \label{sec:appendix}

This chapter contains supplementary material for additional insight, as well as plots that provide more qualitative information.
In addition, some tables are included here that provide more detailed insights into the data compilation process.
Everything is arranged chronologically according to occurrence in the main section and shares the headline of each chapter for easy reference.

\section{Sources}

\begin{table}
  \centering
  \caption{Table of the first half of the $\num{72}$ GFU-gold events used as sources in this analysis. Shown are the features time in MJD, declination $\delta$ in degrees, right ascension $\alpha$ also in degrees and signalness in percent. The time-dependent analysis uses a subset of these sources highlighted in red. The order of the sources corresponds to the processing order in the analysis pipeline.}
  \label{tab:sources_v2}
  \begin{tabular}{ccrrc}
    \toprule
    Nr. & MJD &  $\delta$ in $\si{\degree}$ & $\alpha$ in $\si{\degree}$ & signalness in $\si{\percent}$ \\
    \toprule
      \input{../tables/sources_table_v2.tex}
    \toprule
  \end{tabular}
\end{table}

\begin{table}
  \centering
  \caption{Table of the second half of the $\num{72}$ GFU-gold events used as sources in this analysis. Shown are the features time in MJD, declination $\delta$ in degrees, right ascension $\alpha$ also in degrees and signalness in percent. The time-dependent analysis uses a subset of these sources highlighted in red. The order of the sources corresponds to the processing order in the analysis pipeline.}
  \label{tab:sources_v2_2}
  \begin{tabular}{ccrrc}
    \toprule
    Nr. & MJD &  $\delta$ in $\si{\degree}$ & $\alpha$ in $\si{\degree}$ & signalness in $\si{\percent}$ \\
    \toprule
      \input{../tables/sources_table_v2_2.tex}
    \toprule
  \end{tabular}
\end{table}

%\begin{table}
%  \centering
%  \caption{Table of the sources used in the time-dependent analysis. Additionally the signalness parameter is shown after which the sources were selected.}
%  \label{tab:sources_time_dep}
%  \begin{tabular}{ccrrc}
%    \toprule
%    Nr. & MJD &  $\delta$ in $\si{\degree}$ & $\alpha$ in $\si{\degree}$ & signalness in $\si{\percent}$ \\
%    \toprule
%      \input{../tables/sources_table_time_dep.tex}
%    \toprule
%  \end{tabular}
%\end{table}

\section{Time-Integrated Search}

\begin{table}
  \centering
  \caption{Table of the number of injected signal events used for the time-integrated analysis.}
  \label{tab:sig_time_int_table}
  \begin{tabular}{r}
    \toprule
    $n_\text{S}$ injected \\
    \toprule
      \input{../tables/sig_time_int_table.tex}
    \toprule
  \end{tabular}
\end{table}

\begin{table}
  \caption{Table of the number of trials for each spectral index $\gamma$ and number of injected signal events $n_\text{sig}$, running $\num{10}$ jobs with $\num{5e3}$ trials per set of parameter pairs $\gamma$ and $n_\text{sig}$. Some jobs fail due to technical reasons.}
  \label{tab:trials_sig_time_int_table}
  \begin{subtable}{\linewidth}
  \centering
  \begin{tabular}{p{.9cm}|rrrrrrrrrr}
    \toprule
    \: $n_\text{sig}$ \newline $\gamma$ \: & \input{../tables/sig_time_int_table_2.tex}
    \toprule
    \input{../tables/trials_sig_time_int_table.tex}
    \toprule
  \end{tabular}
\end{subtable}
\begin{subtable}{\linewidth}
\centering
  \begin{tabular}{p{.9cm}|rrrrrrrrrr}
    \toprule
    \: $n_\text{sig}$ \newline $\gamma$ \: & \input{../tables/sig_time_int_table_3.tex}
    \toprule
    \input{../tables/trials_sig_time_int_table_2.tex}
    \toprule
  \end{tabular}
  \end{subtable}
\end{table}

\section{Time-Dependent Search} \label{sec:time_dep_search_appendix}

In this chapter the complete results for all $\num{10}$ sources can be found.

\subsection{Background Trials}

\begin{figure}
    \centering
    \includegraphics[width=\linewidth-2cm]{Plots/05_csky/9_years_gfu_gold_time_dep_bg_t0.pdf}
    \caption{Histograms of the background test statistic values for all $\num{10}$ sources used in the time-dependent analysis. Shown are also the number of degrees of freedom $dof$ and the ratio of positive and negative values $\eta$. The id of the sources corresponds to the tables \ref{tab:sources_v2} and \ref{tab:sources_v2_2}.}
    \label{fig:bg_trials_time_dep}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{Plots/05_csky/9_years_gfu_gold_time_dep_bg_dt.pdf}
    \caption{Histograms of the background time window lengths $dt$ in days of all $\num{10}$ sources for the time-dependent analysis.}
    \label{fig:bg_trials_time_dep_time_windows}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{Plots/05_csky/time_window_ns_bg_time_dep.pdf}
    \caption{Histograms of the fitted number of signal events $\hat{n}_\text{S}$ in dependence of the time window lengths $dt$ in days of the background trials for the time-dependent analysis for all $\num{10}$ sources.}
    \label{fig:bg_trials_time_dep_time_windows_ns}
\end{figure}

\newpage
\subsection{Signal Trials}

\begin{table}
  \centering
  \caption{Table of the number of trials for each source index and number of injected signal events $n_\text{sig}$, running $\num{5}$ jobs with $\num{e4}$ trials per set of parameter pairs of source and $n_\text{sig}$. Some jobs fail due to technical reasons.}
  \label{tab:trials_sig_time_dep_table}
  \begin{tabular}{>{\centering\arraybackslash}p{.9cm}|%
                    cccccccccc}
    \toprule
    \: Nr. \newline $n_\text{sig}$ \: & \input{../tables/trials_sig_time_dep_src_table.tex}
    \toprule
    \input{../tables/trials_sig_time_dep_table.tex}
    \toprule
  \end{tabular}
\end{table}

\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{Plots/appendix/llh_scan.pdf}
    \caption{Scan of the likelihoodspace for all $\num{10}$ sources with a timewindow of $\SI{200}{\day}$ for the time-dependent analysis. The scan is in the spectral index $\gamma$ and the signal parameter $n_\text{S}$. The number of induced signal events is $n_S = \num{10}$ with a spectral index of $\gamma = 2$. The maximum test statistic value is marked in the plot including the contours of $\num{1}\sigma$ and $\num{2}\sigma$ and source number corresponds to the tables \ref{tab:sources_v2} and \ref{tab:sources_v2_2} in the appendix.}
    \label{fig:llh_scan_time_dep_all}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{Plots/appendix/9_years_gfu_gold_time_dep_cdf_sens.pdf}
    \caption{Quantiles of the signal trials for the calculation of the discovery potential for the time-dependent analysis of all $\num{10}$ sources at a spectral index of $\gamma=\num{2}$. A $\chi^2$ CDF fit provides a more accurate estimate of the sought signal parameter $n_\text{S}$ which satisfies the condition of the sensitivity at $\SI{90}{\percent}$ represented via a dashed line.}
    \label{fig:time_dep_cdf_sens}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{Plots/appendix/9_years_gfu_gold_time_dep_cdf_disc.pdf}
    \caption{Quantiles of the signal trials for the calculation of the discovery potential for the time-dependent analysis of all $\num{10}$ sources at a spectral index of $\gamma=\num{2}$. A $\chi^2$ CDF fit provides a more accurate estimate of the sought signal parameter $n_\text{S}$ which satisfies the condition of the discovery potential at $\SI{50}{\percent}$ represented via a dashed line.}
    \label{fig:time_dep_cdf_disc}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{Plots/appendix/9_years_gfu_gold_time_dep_sig_sens_ts.pdf}
    \caption{Histogram of the background trials for the time-dependent analysis for all $\num{10}$ sources. Shown is also the set of signal trials with the number of injected signal events closest to satisfying the condition to calculate the sensitivity. The median of the background test statistics is not plotted as it is very close to the origin for all sources.}
    \label{fig:time_dep_sig_sens_ts}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{Plots/appendix/9_years_gfu_gold_time_dep_sig_disc_ts.pdf}
    \caption{Histogram of the background trials for the time-dependent analysis for all $\num{10}$ sources. Shown is also the set of signal trials with the number of injected signal events closest to satisfying the condition to calculate the discovery potential. The grey dashed lines represent $\num{3}\sigma$ and $\num{5}\sigma$ of the background test statistic.}
    \label{fig:time_dep_sig_disc_ts}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{Plots/appendix/time_dep_sens_disc_dec_time_2.pdf}
    \caption{Sensitivities and discovery potentials for all $\num{10}$ sources in dependece of their position at a reference energy of $E_0 = \SI{100}{\tera\electronvolt}$ for the time-dependent analysis. The colour represents the arrival time of the source event and the errorbars the uncertainty in declination.}
    \label{fig:sens_disc_time_dep_dec}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{Plots/appendix/9_years_gfu_gold_time_dep_sens_dt.pdf}
    \caption{Histograms of the time window lengths $dt$ in days of all $\num{10}$ sources for the time-dependent analysis for the set of signal trials with the number of injected signal events closest to satisfying the condition to calculate the sensitivity.}
    \label{fig:sens_dt_all}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{Plots/appendix/9_years_gfu_gold_time_dep_disc_dt.pdf}
    \caption{Histograms of the time window lengths $dt$ in days of all $\num{10}$ sources for the time-dependent analysis for the set of signal trials with the number of injected signal events closest to satisfying the condition to calculate the discovery potential.}
    \label{fig:disc_dt_all}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{Plots/appendix/time_window_ns_sens_time_dep.pdf}
    \caption{Histograms of the time window lengths $dt$ in days in dependence of the fitted signal parameter $\hat{n}_\text{S}$ of all $\num{10}$ sources for the time-dependent analysis for the set of signal trials with the number of injected signal events closest to satisfying the condition to calculate the sensitivity.}
    \label{fig:sens_ns_dt_all}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{Plots/appendix/time_window_ns_disc_time_dep.pdf}
    \caption{Histograms of the time window lengths $dt$ in days in dependence of the fitted signal parameter $\hat{n}_\text{S}$ of all $\num{10}$ sources for the time-dependent analysis for the set of signal trials with the number of injected signal events closest to satisfying the condition to calculate the discovery potential.}
    \label{fig:disc_ns_dt_all}
\end{figure}

\newpage
\subsection{Examination of Fit Bias} \label{sec:fit_bias_time_dep}

\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{Plots/appendix/gamma_fit_time_dep.pdf}
    \caption{Fitted spectral index $\hat\gamma$ in dependence of the injected number of signal events $n_\text{inj}$ with spectral index $\gamma$, shown with a horizontal black dashed line, for the trials used in the time-dependent analysis.}
    \label{fig:gamma_fit_time_dep}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{Plots/appendix/ns_fit_time_dep.pdf}
    \caption{Fitted number of signal events $\hat{n}_{\text{S}}$ in dependence of the injected number of signal events $n_\text{inj}$ with spectral index $\gamma$ for the time-dependent analysis. The black dashed line shows the equality of fitted and injected number of signal events.}
    \label{fig:ns_fit_time_dep}
\end{figure}

\section{Conclusion and Outlook}

This chapter contains the figure for the attempted trial correction.
Adding this into the main part would hurt the reading flow too much, thus its positioning here.

\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{Plots/appendix/post_trial_p_values_1.pdf}
    \caption{Attempted trial correction for the time-dependent analysis. Normally the incline of the blue line should not be greater than the incline of the diagonal dashed line.}
    \label{fig:post_trials}
\end{figure}

\chapter{Reproduction}

This chapter contains all the necessary information to reproduce the analyses.

\section{Main Analyses}

The analysis repo can be found at \url{https://github.com/cybajohn/csky_gfu_stacking}.
The analysis was written on the external server cobalt and is located at
\begin{verbatim}
          /home/jkollek/punktquellensuche/csky_ehe_stacking.
\end{verbatim}
It was written in \texttt{Python3} version 3.7.5 and uses \texttt{csky} version 1.1.7.
To compile it, the shell under
\begin{verbatim}
          /home/jkollek/venvs/py3v4/bin/python
\end{verbatim}
was used.
This shell contains all the necessary dependencies to run the analysis.
In order to be able to reproduce the analysis, the directories in the \texttt{\_paths.py} file must first be adapted to the user.
The analysis should be done in three main steps, the data preparation, the time-integrated analysis and the time-dependent analysis.

\subsection{Data Preparation}
The first step is to create the source files for the neutrino sources through the \texttt{make\_source\_files\_from\_fits.py} file.
The skymaps are created by the file \texttt{make\_skymap.py}.
This is followed by the creation of the preprocessed datasets.
The script \texttt{check\_gold\_filter\_jobs.py} creates job files which can be processed on the server condor, these use the script \texttt{check\_gold\_mc\_ids.py} and can be started in the job folder with the bash command on condor,\\ (here: \texttt{bash ehe\_transient\_stacking.dag.start.sh}).
Once the scripts have run, they can be collected via \texttt{check\_gold\_filter\_combine.py} and the actual prepared datasets can be created via the \texttt{remove\_gold\_from\_data.py} script.
These datasets can now be inserted into \texttt{csky} into the \texttt{selections.py} file via creating a new dataset class.

\begin{verbatim}
class my_cleaned_data(PSDataSpec):
    _user_path = os.path.join("/data","user","jkollek",
                              "csky_ehe_stacking","rawout_tests",
                              "cleaned_datasets_new")
    _path_sig = os.path.join(_user_path,'IC86_2016_MC.npy')
    _path_data = [os.path.join(_user_path,'IC86_2011_exp.npy'),
                  os.path.join(_user_path,'IC86_2012_exp.npy'),
                  os.path.join(_user_path,'IC86_2013_exp.npy'),
                  os.path.join(_user_path,'IC86_2014_exp.npy'),
                  os.path.join(_user_path,'IC86_2015_exp.npy'),
                  os.path.join(_user_path,'IC86_2016_exp.npy'),
                  os.path.join(_user_path,'IC86_2017_exp.npy'),
                  os.path.join(_user_path,'IC86_2018_exp.npy'),
                  os.path.join(_user_path,'IC86_2019_exp.npy')]
    _path_grls = [os.path.join(_user_path,'GRL','IC86_2011_exp.npy'),
                  os.path.join(_user_path,'GRL','IC86_2012_exp.npy'),
                  os.path.join(_user_path,'GRL','IC86_2013_exp.npy'),
                  os.path.join(_user_path,'GRL','IC86_2014_exp.npy'),
                  os.path.join(_user_path,'GRL','IC86_2015_exp.npy'),
                  os.path.join(_user_path,'GRL','IC86_2016_exp.npy'),
                  os.path.join(_user_path,'GRL','IC86_2017_exp.npy'),
                  os.path.join(_user_path,'GRL','IC86_2018_exp.npy'),
                  os.path.join(_user_path,'GRL','IC86_2019_exp.npy')]
    _bins_sindec = np.unique(np.concatenate([
                        np.linspace(-1, -0.93, 4 + 1),
                        np.linspace(-0.93, -0.3, 10 + 1),
                        np.linspace(-0.3, 0.05, 9 + 1),
                        np.linspace(0.05, 1, 18 + 1) ]) )
    _bins_logenergy = np.arange(1, 9.5 + 0.01, 0.125)
\end{verbatim}

\subsection{Time-Integrated Analysis}

Both analyses are basically structured in the same way.
First the background trials are calculated and then the signal trials.
Before the actual background trials, the trials can be tested with the help of the \texttt{bg\_trial.py} script.
This is a simple setup to see how the trials work.
However, this script is not required for the analysis.
The analysis starts with the \texttt{bg\_trial\_jobs.py} script, which as before creates jobfiles for use on condor.
As before, these are collected via the \texttt{bg\_trial\_combine.py} script.
The signal trials have the same structure.

\subsection{Time-Dependent Analysis}

The same procedure as before applies here, the time-dependent scripts are identified by the \texttt{\_time\_dependent} suffix.
The post-trials can be executed via the \texttt{post\_trial*} scripts.
The scripts with the \texttt{inspect*} prefix are used to create additional plots and provide extra insight into the quantitative content of the analyses.

\section{Time-Dependent Stacking Software Approach}

The repository for the attempted analysis can be found at \url{https://github.com/cybajohn/ehe_transient_stacking_analysis_tests} and the modified \texttt{tdepps} software at \url{https://github.com/cybajohn/tdepps}.
The order of the scripts can be inferred from their name, other than that, technicalities like adjusting path names need to be done first like explained in the other analyses.
This analysis repository was formed by the constant tests of the performance of the new \texttt{tdepps} software and is therefore unfortunately not so clearly comprehensible.
An important point worth mentioning is that the analysis parameters can be adjusted in the script.
